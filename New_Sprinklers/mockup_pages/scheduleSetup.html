<meta name="viewport" content="width=device-width, initial-scale=1" user-scalable=no>
<style>
html{
	font-size:4vw;
}
@media screen and (min-width: 700px){
	html {
	    font-size: 35px;
	}
}
button{
		border-radius:10px;
		border:solid black 1px;
		font-weight:bold;
		margin:.3rem;
		padding:.1rem;
}
input:hover, select:hover{
	background:rgba(240,240,255,1);
}
svg{
		padding:.5rem;
}
svg:hover{
	transform:scale(1.2);
}

input,select{
	border:none;
	text-align:center;
}
*{	
	font-family:sans-serif;
	font-size:1rem;
}
td{
	text-align:center;
}
tr{
	border-bottom:1px solid rgba(230,230,230,1);
}
input[type=checkbox]{
	transform:scale(1.5);
}
#myFilter{
	position: absolute;
	background: rgb(235, 235, 235);
	top: 18px;
	padding: 5px;
	left: 472px;
	box-shadow: 2px 2px 10px;
}
.comButton{
	border-radius: 10px;
	border: solid black 3px;
	font-weight: bolder;
	margin-left:20px;
}
th{
	background:rgba(240,240,240,1);
	border-left:inset 2px;
	border-right:inset 2px;
	cursor:pointer;
}
</style>
<html>
<div style=display:none; id=myFilter></div>
<table  style=text-align:center;margin:auto;width:100%;margin-bottom:1rem;><tr><td><svg onclick=navigate("/index.html") width=2rem viewBox="0 0 24 24" ><path d="M0 0h24v24H0V0z" fill="none"/><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z"/></svg></td>
<td style=font-size:1.5rem;font-weight:bold;>Sprinkler Schedule</td>
<td ><svg onclick=navigate("/settings.html")  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width=2rem><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
</tr></table>
<div style=text-align:center;>
		<button onclick=saveSchedule()>Save Changes</button>
<div>
		<div style=font-size:.5rem;>
		Click headers to sort<br>
		Right click to filter zone or day
		</div>
		<table style=margin:auto;width:90%;border-collapse:collapse><tbody id=setTimes>
				<tr id=header style="border-bottom:solid black 3px">
					<th id=z onclick=tsort(this,[z,t,d])>Zone</th><th id=d onclick=tsort(this,[d,z,t]) >Day</th><th  id=t onclick=tsort(this,[t,z,d]) >Time</th><th id=r onclick=tsort(this,[d,t,z])>Run Time</th><th>Actions</th>
				</tr>
		</tbody></table>
</div>
<div style="text-align:center;margin-top:10px;" id=SPs>
		<button  onclick=addSP()>Add Time</button>
</div>


</html>


<script>
schedule2=JSON.parse(JSON.stringify(schedule));
saveCheck=false;
zones = [0, 1, 2, 3, 4, 5, 6, 7];
days = "Sun,Mon,Tues,Wed,Thur,Fri,Sat".split(",");

function setup() {
	if (schedule){
		for (var x = 0; x < 160; x++) {
			if (schedule[x][4] > 0) {
				addSP(...schedule[x], x, true);
			}
		}
	} else {
		schedule = [];
		for (var y = 0; y < 160; y++) {
			schedule[y] = [0, 0, 0, 0, 0];
		}
	}
	qs("#z,#d").forEach(ele => ele.oncontextmenu = function () {
	makeFilter(ele, event);
});
	tsort(d, [d, z, t]);
	document.onclick = function (event) {
		if (!(IN(myFilter, event.path))) myFilter.style.display = "none";
	};
}
setup();

function IN(val, arr) {
	if (Array.from(arr).indexOf(val) > -1) {
		return true;
	} else {
		return false;
	}
}

function makeFilter(ele, event) {
	event.preventDefault();
	tsort(ele);
	var values = getCol(ele.cellIndex, 1).map(ele => ele.dataset.value).filter((v, i, a) => a.indexOf(v) === i);
	var labels = getCol(ele.cellIndex, 1).map(ele => ele.firstChild.selectedOptions[0].innerText).filter((v, i, a) => a.indexOf(v) === i);
	var data = "Select Values<br>";
	for (var x in values) {
		data += '<input class=filterItem type=checkbox checked value=' + values[x] + '>' + labels[x] + '<br>';
	}
	data += '<button onclick=filterRows('+ele.cellIndex+')>Filter</button>';
	myFilter.innerHTML = data;
	myFilter.style.top = event.pageY;
	myFilter.style.left = event.pageX;
	myFilter.style.display = "";
}

function filterRows(col) {	
	table=setTimes;
	console.log(arguments);
	var selected=qs(".filterItem").filter((ele)=>{if(ele.checked)return ele.value;}).map(ele=>Number(ele.value));
	Array.from(table.rows).forEach(ele => ele.style.display = "");
	var cols = getCol(col, 1);
	var failures = cols.map((col) => {
		if (!(IN(Number(col.dataset.value), selected))) return col.parentElement;
	}).filter(ele => ele != undefined);
	failures.forEach(ele => ele.style.display = "none");
	myFilter.style.display="none";
	console.log(failures);
}

function getCol(col, firstrow = 0, lastrow = false, table = setTimes) {
	if (!lastrow) {
		lastrow = table.rows[0].length;
	}
	return columns = Array.from(table.rows).map((row) => row.cells[col]).slice(firstrow, lastrow);
}

function tsort(ele, ps = false) {
	if (ps) {
		for (var x in ps) {
			tsort(ps[x]);
		}
	}
	var set = getCol(ele.cellIndex, 1).map((ele) => {
		return [Number(ele.dataset.value), ele.parentElement];
	}).sort(function (first, second) {
		return first[0] - second[0];
	});
	for (var y = 0; y < set.length; y++) {
		setTimes.rows[y + 1].parentNode.insertBefore(set [y][1], setTimes.rows[y + 1]);
	}
}

function update(ele) {
	saveCheck=true;
	index = ele.parentElement.parentElement.id;
	if (ele.parentElement.cellIndex == 2) {
		var time = ele.value.split(":");
		schedule[index][2] = Number(time[0]);
		schedule[index][3] = Number(time[1]);
		time = (Number(time[0]) * 60) + Number(time[1]);
		ele.parentElement.dataset.value = time;
	} else if (ele.parentElement.cellIndex == 3) {
		schedule[index][4] = Number(ele.value);
		ele.parentElement.dataset.value = Number(ele.value);
	} else {
		schedule[index][ele.parentElement.cellIndex] = Number(ele.value);
		ele.parentElement.dataset.value = ele.value;
	}
}

function zoneSelect(list, val, cName) {
	var s = "<select onchange=update(this) class=" + cName + ">";
	for (var x in list) {
		if (val == x) {
			s += "<option value=" + x + " selected>" + list[x] + "</option>";
		} else {
			s += "<option value=" + x + ">" + list[x] + "</option>";
		}
	}
	s += "</select>";
	return s;
}

function addSP() {
	var trash = '<svg xmlns="http://www.w3.org/2000/svg" height=1.5rem viewBox="0 0 24 24" width=1.5rem onclick=remove(this,this.parentElement.parentElement.id)><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/><path d="M0 0h24v24H0z" fill="none"/></svg>';
	console.log(arguments);
	if (arguments[6] === true) {
		var zone = arguments[0];
		var day = arguments[1];
		var hour = arguments[2];
		var minute = arguments[3];
		var time = (hour * 60) + minute;
		var length = arguments[4];
		var arrSpot = arguments[5];
		if (length == 0) {
			return;
		}
		setTimes.insertAdjacentHTML('beforeend', '<tr id=' + arrSpot + '><td data-value=' + zone + '>' + zoneSelect(zones, zone, 'zone') + '</td><td data-value=' + day + '>' + zoneSelect(days, day, 'day') + '</td><td data-value=' + time + '><input onchange=update(this) type=time value=' + String(hour).padStart(2, '0') + ':' + String(minute).padStart(2, '0') + '></td><td data-value=' + length + '><input onchange=update(this) type=number max=125 min=0 value=' + length + '></td><td>' + trash + '</td></tr>');
	} else if (arguments.length == 0) {
		var arrSpot = vacancy_check(true);
		if (arrSpot == -1) {
			alert("Too many actions scheduled!nDelete a schedule point to free up memory!");
		} else {
			saveCheck=true;
			schedule[arrSpot] = [0, 0, 0, 0, 0];
			setTimes.insertAdjacentHTML('beforeend', '<tr id=' + arrSpot + '><td data-value=0>' + zoneSelect(zones, 0, 'zone') + '</td><td data-value=0>' + zoneSelect(days, 0, 'day') + '</td><td data-value=0><input onchange=update(this) type=time value=00:00></td><td data-value=0><input onchange=update(this) type=number max=125 min=0 value=0></td><td>' + trash + '</td></tr>');
		}
	}
}
function remove(ele, index) {
	ele.parentElement.parentElement.remove();
	schedule[Number(index)] = [0, 0, 0, 0, 0];
}
function vacancy_check(fo = false) {
	var n = 0;
	var vac = [];
	for (var x = 0; x < 160; x++) {
		if (schedule[x][4] == 0 && !(IN(x, qs("tr").map(ele => Number(ele.id))))) {
			if (fo) return x;
			vac[n] = x;
			n += 1;
		}
	}
	if (fo) return -1;
	return {
		"num": n,
		"pos": vac
	};
}

function saveSchedule() {
	saveCheck=false;
	for (var x in schedule) {
		if (JSON.stringify(schedule[x])!=JSON.stringify(schedule2[x])) {
			var pos = x;
			var arr = schedule[x];
			var zone = schedule[x][0];
			var day = schedule[x][1];
			var hour = schedule[x][2];
			var minute = schedule[x][3];
			var runtime = schedule[x][4];
			var packet="id=schedule&pos=" + x + "&zone=" + zone + "&day=" + day + "&hour=" + hour + "&minute=" + minute + "&runtime=" + runtime;
			sendData(packet);
		}
	}
	var packet="id=scheduleDone";
	sendData(packet);
	schedule2=JSON.parse(JSON.stringify(schedule));
}

function sendData(packet){
	var request = new XMLHttpRequest();
	console.log("Sending:",packet);
	request.open("POST", "saveData.html", true);
	request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
	request.onreadystatechange = function () {
		if (this.readyState == 4 && this.status == 200) {
			console.log(this.responseText);
		}
	};
	request.send(packet);
}
	

function qs(...args) {
	var arr = [];
	for (var x = 0; x < args.length; x++) {
		arr = [...arr, ...document.querySelectorAll(args[x])];
	}
	if (arr.length == 1) {
		return arr[0];
	} else {
		return arr;
	}
}
function navigate(url){
		if (saveCheck){
			if (confirm("Save Changes Before You Leave?")){
				saveSchedule();
			}
	}
	location=url;
}
</script>


